<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings – Tournament Countdown</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <main class="container">
    <h1>Settings</h1>
    <form id="settingsForm" class="settings-form" autocomplete="off">
      <fieldset>
        <legend>Timer</legend>
        <label>Default duration (seconds)
          <input type="number" id="defaultDurationSeconds" min="0" step="1">
        </label>
        <label>Presets (comma separated seconds)
          <input type="text" id="presets" placeholder="30,45,60">
        </label>
      </fieldset>

      <fieldset>
        <legend>GPIO / Relay</legend>
        <label class="inline"><input type="checkbox" id="gpioEnabled"> Enable GPIO</label>
        <label>Relay pin (BCM)
          <input type="number" id="relayPin" min="0" step="1">
        </label>
        <label>Relay active high
          <select id="relayActiveHigh">
            <option value="true">Active HIGH</option>
            <option value="false">Active LOW</option>
          </select>
        </label>
        <label>Blink Hz
          <input type="number" id="blinkHz" min="0" step="0.1">
        </label>
        <label>Blink duration (ms)
          <input type="number" id="blinkDurationMs" min="0" step="100">
        </label>
      </fieldset>

      <fieldset>
        <legend>Theme</legend>
        <label class="inline"><input type="checkbox" id="themeEnabled"> Enable custom theme</label>
        <label>Background color
          <input type="color" id="themeBg" value="#0b1020">
        </label>
        <label>Text color
          <input type="color" id="themeText" value="#e5e7eb">
        </label>
        <label>Heading color
          <input type="color" id="themeHeading" value="#93c5fd">
        </label>
        <label>Primary start
          <input type="color" id="themePrimaryStart" value="#2563eb">
        </label>
        <label>Primary end
          <input type="color" id="themePrimaryEnd" value="#1d4ed8">
        </label>
      </fieldset>

      <fieldset>
        <legend>Sound</legend>
        <label class="inline"><input type="checkbox" id="soundEnabled"> Enable end sound</label>
        <label>Volume (0..1)
          <input type="number" id="soundVolume" min="0" max="1" step="0.05" value="1">
        </label>
        <label>Audio URL (optional)
          <input type="text" id="soundEndUrl" placeholder="/sounds/end.mp3 or https://...">
        </label>
        <label>Pick from /sounds
          <div class="settings-actions inline">
            <select id="soundPicker"></select>
            <button type="button" id="refreshSounds" class="tertiary">Refresh</button>
          </div>
        </label>
        <div class="settings-actions inline">
          <button type="button" id="testSound" class="tertiary">Test</button>
          <button type="button" id="stopSound" class="secondary">Stop</button>
          <button type="button" id="useBeep" class="tertiary">Use default beep</button>
        </div>
      </fieldset>

  <div class="settings-actions">
        <button type="submit">Save</button>
        <a class="secondary" href="/">Back</a>
      </div>
  <div id="saveStatus" class="status idle mt-sm" aria-live="polite">Idle</div>
    </form>
  </main>

  <script src="/theme.js"></script>
  <script>
    async function loadSettings() {
      const res = await fetch('/api/settings');
      const data = await res.json();
      const s = data.settings || {};
      document.getElementById('defaultDurationSeconds').value = s.defaultDurationSeconds ?? 45;
      document.getElementById('presets').value = (s.presets || []).join(',');
      document.getElementById('gpioEnabled').checked = !!s.gpio?.enabled;
      document.getElementById('relayPin').value = s.gpio?.relayPin ?? 17;
      document.getElementById('relayActiveHigh').value = String(!!s.gpio?.relayActiveHigh);
      document.getElementById('blinkHz').value = s.gpio?.blinkHz ?? 2;
      document.getElementById('blinkDurationMs').value = s.gpio?.blinkDurationMs ?? 10000;
  // theme
  const t = s.theme || {};
  document.getElementById('themeEnabled').checked = !!t.enabled;
  const c = t.colors || {};
  if (c.bg) document.getElementById('themeBg').value = c.bg;
  if (c.text) document.getElementById('themeText').value = c.text;
  if (c.heading) document.getElementById('themeHeading').value = c.heading;
  if (c.primaryStart) document.getElementById('themePrimaryStart').value = c.primaryStart;
  if (c.primaryEnd) document.getElementById('themePrimaryEnd').value = c.primaryEnd;
  try { window.__applyTheme(t); } catch {}
  // sound
  const snd = s.sound || {};
  document.getElementById('soundEnabled').checked = snd.enabled ?? true;
  document.getElementById('soundVolume').value = snd.volume ?? 1;
  document.getElementById('soundEndUrl').value = snd.endUrl ?? '';
      // populate picker
      await loadSoundsIntoPicker();
      // preselect if matches
      try {
        const picker = document.getElementById('soundPicker');
        const current = document.getElementById('soundEndUrl').value;
        const found = Array.from(picker.options).find(o => o.value === current);
        if (found) picker.value = current; else picker.value = '';
      } catch {}
    }

    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        defaultDurationSeconds: Number(document.getElementById('defaultDurationSeconds').value || 0),
        presets: String(document.getElementById('presets').value || '').split(',').map(x => Number(x.trim())).filter(n => !isNaN(n)),
        gpio: {
          enabled: document.getElementById('gpioEnabled').checked,
          relayPin: Number(document.getElementById('relayPin').value || 17),
          relayActiveHigh: document.getElementById('relayActiveHigh').value === 'true',
          blinkHz: Number(document.getElementById('blinkHz').value || 2),
          blinkDurationMs: Number(document.getElementById('blinkDurationMs').value || 10000),
        },
        theme: {
          enabled: document.getElementById('themeEnabled').checked,
          colors: {
            bg: document.getElementById('themeBg').value,
            text: document.getElementById('themeText').value,
            heading: document.getElementById('themeHeading').value,
            primaryStart: document.getElementById('themePrimaryStart').value,
            primaryEnd: document.getElementById('themePrimaryEnd').value
          }
        },
        sound: {
          enabled: document.getElementById('soundEnabled').checked,
          volume: Number(document.getElementById('soundVolume').value || 1),
          endUrl: String(document.getElementById('soundEndUrl').value || '')
        }
      };
      const status = document.getElementById('saveStatus');
      status.textContent = 'Saving...';
      status.className = 'status running';
      try {
        const res = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const data = await res.json();
        if (data.ok) {
          try { window.__applyTheme(payload.theme); } catch {}
          status.textContent = 'Saved';
          status.className = 'status done';
          setTimeout(() => { status.textContent = 'Idle'; status.className = 'status idle'; }, 1500);
        } else {
          throw new Error('Save failed');
        }
      } catch (e) {
        status.textContent = 'Error saving';
        status.className = 'status warning';
      }
    });

    loadSettings();
  </script>
  <script>
    async function loadSoundsIntoPicker(){
      try {
        const res = await fetch('/api/sounds');
        const data = await res.json();
        const items = Array.isArray(data.items) ? data.items : [];
        const picker = document.getElementById('soundPicker');
        picker.innerHTML = '';
        const empty = document.createElement('option');
        empty.value = '';
        empty.textContent = '— Select a sound —';
        picker.appendChild(empty);
        for (const it of items) {
          const opt = document.createElement('option');
          opt.value = it.url;
          opt.textContent = it.name;
          picker.appendChild(opt);
        }
      } catch {}
    }
    document.getElementById('soundPicker').addEventListener('change', () => {
      const picker = document.getElementById('soundPicker');
      const url = picker.value || '';
      document.getElementById('soundEndUrl').value = url;
    });
    document.getElementById('refreshSounds').addEventListener('click', loadSoundsIntoPicker);
    // Local test controls (don’t persist)
    let __testAudio = null;
    document.getElementById('testSound').addEventListener('click', async () => {
      const enabled = document.getElementById('soundEnabled').checked;
      const vol = Number(document.getElementById('soundVolume').value || 1);
      const url = String(document.getElementById('soundEndUrl').value || '').trim();
      try { __testAudio?.pause?.(); } catch {}
      __testAudio = null;
      if (!enabled) return;
      if (url) {
        try { __testAudio = new Audio(url); __testAudio.volume = Math.max(0, Math.min(1, vol)); await __testAudio.play(); } catch (e) { console.warn('Test audio failed', e); }
      } else {
        // fallback to beep via WebAudio
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          const dur = 0.35; const now = ctx.currentTime;
          osc.type = 'sine';
          osc.frequency.setValueAtTime(880, now);
          osc.frequency.exponentialRampToValueAtTime(440, now + dur * 0.6);
          osc.frequency.exponentialRampToValueAtTime(660, now + dur);
          gain.gain.setValueAtTime(0.001, now);
          gain.gain.exponentialRampToValueAtTime(Math.max(0.05, Math.min(1, vol)), now + 0.05);
          gain.gain.exponentialRampToValueAtTime(0.001, now + dur);
          osc.connect(gain).connect(ctx.destination);
          osc.start(now); osc.stop(now + dur + 0.02);
        } catch {}
      }
    });
    document.getElementById('stopSound').addEventListener('click', () => { try { __testAudio?.pause?.(); } catch {} });
    document.getElementById('useBeep').addEventListener('click', () => { document.getElementById('soundEndUrl').value = ''; });
  </script>
</body>
</html>
