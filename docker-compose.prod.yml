version: '3.8'

services:
  # GPIO Service - Python-based GPIO control
  gpio-service:
    build: ./gpio-service
    container_name: gpio-service
    environment:
      - GPIO_ENABLED=true
      - RELAY_PIN=17  # BCM pin 17
      - RELAY_ACTIVE_HIGH=0  # Active LOW relay (LOW = ON, HIGH = OFF)
    volumes:
      # Mount GPIO devices for Raspberry Pi GPIO access
      - /dev/gpiomem:/dev/gpiomem
      - /dev/mem:/dev/mem
      - /sys:/sys:rw
    devices:
      - /dev/gpiomem:/dev/gpiomem
      - /dev/gpiochip0:/dev/gpiochip0
      - /dev/gpiochip1:/dev/gpiochip1
      - /dev/gpiochip2:/dev/gpiochip2
    privileged: true
    user: root  # Required for GPIO access
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:3001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - app-network

  # Main Node.js Application
  counter-web:
    image: ghcr.io/xaxy55/tournament-countdown:latest
    container_name: counter-web-app
    environment:
      - NODE_ENV=production
      - GPIO_ENABLED=true
      - GPIO_SERVICE_URL=http://gpio-service:3001  # Connect to GPIO service
      - RELAY_PIN=17  # For reference/logging
      - RELAY_ACTIVE_HIGH=0  # For reference/logging
      - BLINK_HZ=2
      - BLINK_DURATION_MS=3000  # How long LED stays on (3 seconds)
    volumes:
      # Mount data directory for persistent settings
      - ./data:/app/data
      # Mount sounds directory if you want to customize sounds
      - ./public/sounds:/app/public/sounds
    depends_on:
      - gpio-service
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Network for inter-service communication
networks:
  app-network:
    driver: bridge
